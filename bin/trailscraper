#!/usr/bin/env python3
import logging
import sys
import os

sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

import click
from trailscraper.s3_download import download_cloudtrail_logs


@click.group()
def root_group():
    """A command-line tool to get valuable information out of AWS CloudTrail."""
    pass


@click.command()
@click.option('--past-days', default=0, help='How many days to look into the past. 0 means today')
@click.option('--bucket', required=True, help='The S3 bucket that contains cloud-trail logs')
@click.option('--prefix', default="", help='Prefix in the S3 bucket (including trailing slash)')
@click.option('--account-id', multiple=True, required=True, help='ID of the account we want to look at')
@click.option('--region', multiple=True, required=True, help='Regions we want to look at')
@click.option('--target-dir', default="~/.trailscraper/logs", type=click.Path(), help='Where to put logfiles')
def download(past_days, bucket, prefix, account_id, region, target_dir, ):
    """Downloads CloudTrail Logs from S3."""
    target_dir = os.path.expanduser(target_dir)

    download_cloudtrail_logs(target_dir, bucket, prefix, past_days, account_id, region)


root_group.add_command(download)

if __name__ == '__main__':
    logger = logging.getLogger()
    handler = logging.StreamHandler()
    formatter = logging.Formatter(
        '%(asctime)s %(name)-12s %(levelname)-8s %(message)s')
    handler.setFormatter(formatter)
    logger.addHandler(handler)
    logger.setLevel(logging.INFO)

    root_group()
